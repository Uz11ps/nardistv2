name: Deploy to Production

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push backend image
        uses: docker/build-push-action@v5
        continue-on-error: false
        with:
          context: ./backend
          push: true
          tags: ghcr.io/uz11ps/nardist-backend:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

      - name: Build and push frontend image
        uses: docker/build-push-action@v5
        continue-on-error: false
        with:
          context: ./frontend
          push: true
          tags: ghcr.io/uz11ps/nardist-frontend:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          timeout: 60s
          command_timeout: 900s
          script: |
            cd /opt/Nardist
            
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–º–∞–Ω–¥—É docker compose
            if command -v docker &> /dev/null && docker compose version &> /dev/null; then
              DOCKER_COMPOSE="docker compose"
            elif command -v docker-compose &> /dev/null; then
              DOCKER_COMPOSE="docker-compose"
            else
              echo "‚ùå Error: docker compose not found!"
              exit 1
            fi
            
            # –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥ (—Å–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ docker-compose.prod.yml)
            git stash || true
            git pull origin main || git pull origin master
            git stash pop || true
            
            # –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
            if [ -f .env ]; then
              set -a
              source .env
              set +a
            fi
            
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º –≥–æ—Ç–æ–≤—ã–µ –æ–±—Ä–∞–∑—ã –∏–∑ GitHub Container Registry
            export BACKEND_IMAGE=ghcr.io/uz11ps/nardist-backend:latest
            export FRONTEND_IMAGE=ghcr.io/uz11ps/nardist-frontend:latest
            
            # –°–∫–∞—á–∏–≤–∞–µ–º –±–∞–∑–æ–≤—ã–µ –æ–±—Ä–∞–∑—ã
            $DOCKER_COMPOSE -f docker-compose.prod.yml pull postgres redis nginx certbot || true
            
            # –ü—ã—Ç–∞–µ–º—Å—è —Å–∫–∞—á–∞—Ç—å –≥–æ—Ç–æ–≤—ã–µ –æ–±—Ä–∞–∑—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π
            BACKEND_PULLED=false
            FRONTEND_PULLED=false
            
            if docker pull ${BACKEND_IMAGE} 2>/dev/null; then
              BACKEND_PULLED=true
              echo "‚úÖ Backend image pulled successfully"
            else
              echo "‚ö†Ô∏è  Backend image not found, will build"
            fi
            
            if docker pull ${FRONTEND_IMAGE} 2>/dev/null; then
              FRONTEND_PULLED=true
              echo "‚úÖ Frontend image pulled successfully"
            else
              echo "‚ö†Ô∏è  Frontend image not found, will build"
            fi
            
            # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–π nginx (Ispmanager) –µ—Å–ª–∏ –æ–Ω –∑–∞–Ω–∏–º–∞–µ—Ç –ø–æ—Ä—Ç—ã 80/443
            systemctl stop nginx 2>/dev/null || true
            systemctl disable nginx 2>/dev/null || true
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ø–æ—Ä—Ç—ã —Å–≤–æ–±–æ–¥–Ω—ã
            if lsof -i :80 2>/dev/null | grep -v docker; then
              echo "‚ö†Ô∏è  Port 80 is occupied by non-docker process, attempting to free it..."
              lsof -ti :80 | xargs kill -9 2>/dev/null || true
            fi
            if lsof -i :443 2>/dev/null | grep -v docker; then
              echo "‚ö†Ô∏è  Port 443 is occupied by non-docker process, attempting to free it..."
              lsof -ti :443 | xargs kill -9 2>/dev/null || true
            fi
            
            # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏ —É–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π nginx –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –µ—Å–ª–∏ –æ–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (–º–æ–∂–µ—Ç –∑–∞–Ω–∏–º–∞—Ç—å –ø–æ—Ä—Ç 80)
            docker stop nardist_nginx_prod 2>/dev/null || true
            docker rm nardist_nginx_prod 2>/dev/null || true
            
            # –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø–æ—Ä—Ç—ã –≤ firewall (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è ufw)
            # –í–ê–ñ–ù–û: –°–Ω–∞—á–∞–ª–∞ –í–°–ï–ì–î–ê –æ—Ç–∫—Ä—ã–≤–∞–µ–º SSH (22), —á—Ç–æ–±—ã –Ω–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ!
            if command -v ufw &> /dev/null; then
              # –°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ –ø—Ä–∞–≤–∏–ª–∞ (–æ—Å–æ–±–µ–Ω–Ω–æ SSH!)
              ufw allow 22/tcp 2>/dev/null || true
              ufw allow 80/tcp 2>/dev/null || true
              ufw allow 443/tcp 2>/dev/null || true
              # –í–∫–ª—é—á–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—â–µ –Ω–µ –≤–∫–ª—é—á–µ–Ω
              if ! ufw status | grep -q "Status: active"; then
                ufw --force enable 2>/dev/null || true
              fi
            fi
            
            # –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã (—Ç–æ–ª—å–∫–æ build –µ—Å–ª–∏ –æ–±—Ä–∞–∑—ã –Ω–µ —Å–∫–∞—á–∞–Ω—ã)
            if [ "$BACKEND_PULLED" = true ] && [ "$FRONTEND_PULLED" = true ]; then
              echo "üöÄ Using pre-built images, skipping build"
              $DOCKER_COMPOSE -f docker-compose.prod.yml up -d --force-recreate --no-build --pull never
            else
              echo "üî® Building missing images..."
              $DOCKER_COMPOSE -f docker-compose.prod.yml up -d --force-recreate --build
            fi
            
            # –ñ–¥–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å–æ–≤
            sleep 10
            
            # –Ø–≤–Ω–æ –∑–∞–ø—É—Å–∫–∞–µ–º nginx –µ—Å–ª–∏ –æ–Ω –Ω–µ –∑–∞–ø—É—â–µ–Ω
            if ! docker ps | grep -q nardist_nginx_prod; then
              echo "‚ö†Ô∏è  Nginx not running, starting it..."
              $DOCKER_COMPOSE -f docker-compose.prod.yml up -d nginx
              sleep 5
            fi
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å nginx
            if docker ps | grep -q nardist_nginx_prod; then
              echo "‚úÖ Nginx container is running"
              # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ nginx –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å–ª—É—à–∞–µ—Ç –Ω–∞ –ø–æ—Ä—Ç–∞—Ö
              if docker exec nardist_nginx_prod nginx -t 2>/dev/null; then
                echo "‚úÖ Nginx configuration is valid"
              else
                echo "‚ö†Ô∏è  Nginx configuration has errors, checking logs..."
                docker logs nardist_nginx_prod --tail 50 || true
              fi
              # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ø–æ—Ä—Ç—ã –∑–∞–Ω—è—Ç—ã docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–º
              if lsof -i :80 2>/dev/null | grep -q docker || ss -tlnp | grep :80 | grep -q docker; then
                echo "‚úÖ Port 80 is bound to docker nginx"
              else
                echo "‚ùå Port 80 is NOT bound to docker nginx! Checking what's using it..."
                lsof -i :80 2>/dev/null || ss -tlnp | grep :80 || true
              fi
            else
              echo "‚ùå Nginx failed to start, checking logs..."
              docker logs nardist_nginx_prod --tail 50 2>/dev/null || true
              echo "üîÑ Attempting to restart nginx..."
              $DOCKER_COMPOSE -f docker-compose.prod.yml restart nginx || $DOCKER_COMPOSE -f docker-compose.prod.yml up -d nginx
            fi
            
            # –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏ (—Å —Ç–∞–π–º–∞—É—Ç–æ–º)
            timeout 60 $DOCKER_COMPOSE -f docker-compose.prod.yml exec -T backend npx prisma migrate deploy || echo "‚ö†Ô∏è  Migrations failed or not needed"
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
            echo "üìä Container status:"
            $DOCKER_COMPOSE -f docker-compose.prod.yml ps || true
            
            # –û—á–∏—Å—Ç–∫–∞ (–Ω–µ –±–ª–æ–∫–∏—Ä—É–µ–º –µ—Å–ª–∏ –¥–æ–ª–≥–æ)
            timeout 30 docker system prune -f || true
            
            echo "‚úÖ Deployment completed successfully!"

