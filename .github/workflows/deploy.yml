name: Deploy to Production

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push backend image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: ghcr.io/uz11ps/nardist-backend:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

      - name: Build and push frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: true
          tags: ghcr.io/uz11ps/nardist-frontend:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          command_timeout: 600s
          script: |
            cd /opt/Nardist
            
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–º–∞–Ω–¥—É docker compose
            if command -v docker &> /dev/null && docker compose version &> /dev/null; then
              DOCKER_COMPOSE="docker compose"
            elif command -v docker-compose &> /dev/null; then
              DOCKER_COMPOSE="docker-compose"
            else
              echo "‚ùå Error: docker compose not found!"
              exit 1
            fi
            
            # –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥
            git pull origin main || git pull origin master
            
            # –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
            if [ -f .env ]; then
              set -a
              source .env
              set +a
            fi
            
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º –≥–æ—Ç–æ–≤—ã–µ –æ–±—Ä–∞–∑—ã –∏–∑ GitHub Container Registry
            export BACKEND_IMAGE=ghcr.io/uz11ps/nardist-backend:latest
            export FRONTEND_IMAGE=ghcr.io/uz11ps/nardist-frontend:latest
            
            # –°–∫–∞—á–∏–≤–∞–µ–º –±–∞–∑–æ–≤—ã–µ –æ–±—Ä–∞–∑—ã
            $DOCKER_COMPOSE -f docker-compose.prod.yml pull postgres redis nginx certbot || true
            
            # –ü—ã—Ç–∞–µ–º—Å—è —Å–∫–∞—á–∞—Ç—å –≥–æ—Ç–æ–≤—ã–µ –æ–±—Ä–∞–∑—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π
            BACKEND_PULLED=false
            FRONTEND_PULLED=false
            
            if docker pull ${BACKEND_IMAGE} 2>/dev/null; then
              BACKEND_PULLED=true
              echo "‚úÖ Backend image pulled successfully"
            else
              echo "‚ö†Ô∏è  Backend image not found, will build"
            fi
            
            if docker pull ${FRONTEND_IMAGE} 2>/dev/null; then
              FRONTEND_PULLED=true
              echo "‚úÖ Frontend image pulled successfully"
            else
              echo "‚ö†Ô∏è  Frontend image not found, will build"
            fi
            
            # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏ —É–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π nginx –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –µ—Å–ª–∏ –æ–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (–º–æ–∂–µ—Ç –∑–∞–Ω–∏–º–∞—Ç—å –ø–æ—Ä—Ç 80)
            docker stop nardist_nginx_prod 2>/dev/null || true
            docker rm nardist_nginx_prod 2>/dev/null || true
            
            # –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø–æ—Ä—Ç—ã –≤ firewall (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è ufw)
            ufw allow 80/tcp 2>/dev/null || true
            ufw allow 443/tcp 2>/dev/null || true
            ufw --force enable 2>/dev/null || true
            
            # –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã (—Ç–æ–ª—å–∫–æ build –µ—Å–ª–∏ –æ–±—Ä–∞–∑—ã –Ω–µ —Å–∫–∞—á–∞–Ω—ã)
            if [ "$BACKEND_PULLED" = true ] && [ "$FRONTEND_PULLED" = true ]; then
              echo "üöÄ Using pre-built images, skipping build"
              $DOCKER_COMPOSE -f docker-compose.prod.yml up -d
            else
              echo "üî® Building missing images..."
              $DOCKER_COMPOSE -f docker-compose.prod.yml up -d --build
            fi
            
            # –ñ–¥–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å–æ–≤
            sleep 10
            
            # –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏
            $DOCKER_COMPOSE -f docker-compose.prod.yml exec -T backend npx prisma migrate deploy || echo "‚ö†Ô∏è  Migrations failed or not needed"
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
            echo "üìä Container status:"
            $DOCKER_COMPOSE -f docker-compose.prod.yml ps
            
            # –û—á–∏—Å—Ç–∫–∞
            docker system prune -f
            
            echo "‚úÖ Deployment completed successfully!"
            exit 0

