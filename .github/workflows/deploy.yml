name: Deploy to Production

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        timeout-minutes: 5

      - name: Set up Docker Buildx
        run: |
          docker buildx version
          docker buildx create --name builder --driver docker-container --use || docker buildx use builder
          docker buildx inspect --bootstrap

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push backend image
        uses: docker/build-push-action@v5
        continue-on-error: false
        with:
          context: ./backend
          push: true
          tags: ghcr.io/uz11ps/nardist-backend:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

      - name: Build and push frontend image
        uses: docker/build-push-action@v5
        continue-on-error: false
        with:
          context: ./frontend
          push: true
          tags: ghcr.io/uz11ps/nardist-frontend:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.0
        env:
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          SSL_EMAIL: ${{ secrets.SSL_EMAIL }}
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          timeout: 60s
          command_timeout: 1800s
          envs: POSTGRES_PASSWORD,JWT_SECRET,TELEGRAM_BOT_TOKEN,SSL_EMAIL
          script: |
            cd /opt/Nardist
            
            # ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñƒ docker compose
            if command -v docker &> /dev/null && docker compose version &> /dev/null; then
              DOCKER_COMPOSE="docker compose"
            elif command -v docker-compose &> /dev/null; then
              DOCKER_COMPOSE="docker-compose"
            else
              echo "âŒ Error: docker compose not found!"
              exit 1
            fi
            
            # ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÐºÐ¾Ð´ (Ð¿Ñ€Ð¸Ð½ÑƒÐ´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ Ð±ÐµÑ€ÐµÐ¼ Ð²ÐµÑ€ÑÐ¸ÑŽ Ð¸Ð· Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ, Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ñ‹Ðµ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ð½Ðµ Ð²Ð°Ð¶Ð½Ñ‹)
            git fetch origin
            git reset --hard origin/main || git reset --hard origin/master
            
            # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¸Ð»Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ .env Ñ„Ð°Ð¹Ð» Ð¸Ð· GitHub Secrets
            echo "ðŸ“ Creating/updating .env file from GitHub Secrets..."
            
            # Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ Ð´Ð»Ñ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾Ð¹ Ð¿ÐµÑ€ÐµÐ´Ð°Ñ‡Ð¸ ÑÐµÐºÑ€ÐµÑ‚Ð¾Ð²
            # ÐŸÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¿ÐµÑ€ÐµÐ´Ð°ÑŽÑ‚ÑÑ Ñ‡ÐµÑ€ÐµÐ· env ÑÐµÐºÑ†Ð¸ÑŽ SSH action
            {
              echo "# Database"
              echo "POSTGRES_USER=${POSTGRES_USER:-nardist}"
              echo "POSTGRES_PASSWORD=${POSTGRES_PASSWORD}"
              echo "POSTGRES_DB=${POSTGRES_DB:-nardist_db}"
              echo ""
              echo "# Backend"
              echo "JWT_SECRET=${JWT_SECRET}"
              echo "TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}"
              echo "NODE_ENV=production"
              echo "PORT=3000"
              echo ""
              echo "# Frontend"
              echo "VITE_API_URL=${VITE_API_URL:-https://nardist.online}"
              echo "VITE_WS_URL=${VITE_WS_URL:-https://nardist.online}"
              echo "FRONTEND_URL=${FRONTEND_URL:-https://nardist.online}"
              echo ""
              echo "# Domain"
              echo "DOMAIN_NAME=${DOMAIN_NAME:-nardist.online}"
              echo "SSL_EMAIL=${SSL_EMAIL}"
              echo ""
              echo "# Docker Images"
              echo "BACKEND_IMAGE=ghcr.io/uz11ps/nardist-backend:latest"
              echo "FRONTEND_IMAGE=ghcr.io/uz11ps/nardist-frontend:latest"
            } > .env
            
            echo "âœ… .env file created/updated"
            
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‡Ñ‚Ð¾ ÐºÑ€Ð¸Ñ‚Ð¸Ñ‡Ð½Ñ‹Ðµ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹ (Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð² ÑÐ¾Ð·Ð´Ð°Ð½Ð½Ð¾Ð¼ Ñ„Ð°Ð¹Ð»Ðµ)
            if ! grep -q "POSTGRES_PASSWORD=.*[^[:space:]]" .env || ! grep -q "JWT_SECRET=.*[^[:space:]]" .env; then
              echo "âš ï¸  WARNING: Some critical secrets may be missing in GitHub Secrets!"
              echo "âš ï¸  Please verify that .env file contains: POSTGRES_PASSWORD, JWT_SECRET, TELEGRAM_BOT_TOKEN, SSL_EMAIL"
            fi
            
            # Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ
            set -a
            source .env
            set +a
            
            # Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ð³Ð¾Ñ‚Ð¾Ð²Ñ‹Ðµ Ð¾Ð±Ñ€Ð°Ð·Ñ‹ Ð¸Ð· GitHub Container Registry
            export BACKEND_IMAGE=ghcr.io/uz11ps/nardist-backend:latest
            export FRONTEND_IMAGE=ghcr.io/uz11ps/nardist-frontend:latest
            
            # Ð¡ÐºÐ°Ñ‡Ð¸Ð²Ð°ÐµÐ¼ Ð±Ð°Ð·Ð¾Ð²Ñ‹Ðµ Ð¾Ð±Ñ€Ð°Ð·Ñ‹ (Ñ sudo ÐµÑÐ»Ð¸ Ð½ÑƒÐ¶Ð½Ð¾)
            sudo $DOCKER_COMPOSE -f docker-compose.prod.yml pull postgres redis nginx certbot 2>/dev/null || \
            $DOCKER_COMPOSE -f docker-compose.prod.yml pull postgres redis nginx certbot || true
            
            # ÐŸÑ‹Ñ‚Ð°ÐµÐ¼ÑÑ ÑÐºÐ°Ñ‡Ð°Ñ‚ÑŒ Ð³Ð¾Ñ‚Ð¾Ð²Ñ‹Ðµ Ð¾Ð±Ñ€Ð°Ð·Ñ‹ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ð¹
            BACKEND_PULLED=false
            FRONTEND_PULLED=false
            
            # ÐŸÑ‹Ñ‚Ð°ÐµÐ¼ÑÑ ÑÐºÐ°Ñ‡Ð°Ñ‚ÑŒ Ð¾Ð±Ñ€Ð°Ð·Ñ‹ (Ñ sudo ÐµÑÐ»Ð¸ Ð½ÑƒÐ¶Ð½Ð¾)
            if sudo docker pull ${BACKEND_IMAGE} 2>/dev/null || docker pull ${BACKEND_IMAGE} 2>/dev/null; then
              BACKEND_PULLED=true
              echo "âœ… Backend image pulled successfully"
            else
              echo "âš ï¸  Backend image not found, will build"
            fi
            
            if sudo docker pull ${FRONTEND_IMAGE} 2>/dev/null || docker pull ${FRONTEND_IMAGE} 2>/dev/null; then
              FRONTEND_PULLED=true
              echo "âœ… Frontend image pulled successfully"
            else
              echo "âš ï¸  Frontend image not found, will build"
            fi
            
            # ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ÑÐ¸ÑÑ‚ÐµÐ¼Ð½Ñ‹Ð¹ nginx (Ispmanager) ÐµÑÐ»Ð¸ Ð¾Ð½ Ð·Ð°Ð½Ð¸Ð¼Ð°ÐµÑ‚ Ð¿Ð¾Ñ€Ñ‚Ñ‹ 80/443
            systemctl stop nginx 2>/dev/null || true
            systemctl disable nginx 2>/dev/null || true
            
            # ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Docker daemon Ð´Ð»Ñ ÑÐ±Ñ€Ð¾ÑÐ° ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ Ð¸ Ñ€ÐµÑˆÐµÐ½Ð¸Ñ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼ Ñ permission denied
            echo "ðŸ”„ Restarting Docker daemon to reset state..."
            sudo systemctl stop docker 2>/dev/null || true
            sleep 3
            sudo systemctl start docker
            sleep 10
            
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‡Ñ‚Ð¾ Ð¿Ð¾Ñ€Ñ‚Ñ‹ ÑÐ²Ð¾Ð±Ð¾Ð´Ð½Ñ‹
            if lsof -i :80 2>/dev/null | grep -v docker; then
              echo "âš ï¸  Port 80 is occupied by non-docker process, attempting to free it..."
              lsof -ti :80 | xargs kill -9 2>/dev/null || true
            fi
            if lsof -i :443 2>/dev/null | grep -v docker; then
              echo "âš ï¸  Port 443 is occupied by non-docker process, attempting to free it..."
              lsof -ti :443 | xargs kill -9 2>/dev/null || true
            fi
            
            # Ð‘ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð°Ñ Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ñ‡ÐµÑ€ÐµÐ· docker compose (Ð¾ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÑ‚ Ð²ÑÐµ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°)
            echo "ðŸ›‘ Stopping existing containers..."
            sudo $DOCKER_COMPOSE -f docker-compose.prod.yml down --remove-orphans 2>/dev/null || \
            $DOCKER_COMPOSE -f docker-compose.prod.yml down --remove-orphans 2>/dev/null || true
            
            # ÐÐ³Ñ€ÐµÑÑÐ¸Ð²Ð½Ð¾Ðµ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ðµ: Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ kill Ð²Ð¼ÐµÑÑ‚Ð¾ stop Ð´Ð»Ñ Ð¾Ð±Ñ…Ð¾Ð´Ð° permission denied
            echo "ðŸ§¹ Collecting and forcefully removing all nardist containers..."
            # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð²ÑÐµ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹ Ñ Ð¿Ñ€ÐµÑ„Ð¸ÐºÑÐ¾Ð¼ nardist (Ð¸Ð¼ÐµÐ½Ð° Ð¸ ID)
            CONTAINERS=$(sudo docker ps -a --no-trunc --filter "name=nardist_" --format "{{.ID}}|{{.Names}}" 2>/dev/null || \
                        docker ps -a --no-trunc --filter "name=nardist_" --format "{{.ID}}|{{.Names}}" 2>/dev/null || echo "")
            
            # Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ð²ÑÐµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð½Ñ‹Ðµ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹ (Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ kill Ð´Ð»Ñ Ð¿Ñ€Ð¸Ð½ÑƒÐ´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾Ð¹ Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸)
            if [ -n "$CONTAINERS" ]; then
              echo "$CONTAINERS" | while IFS='|' read -r id name; do
                if [ -n "$id" ]; then
                  echo "  Force removing: $name ($id)"
                  # Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ kill Ð²Ð¼ÐµÑÑ‚Ð¾ stop Ð´Ð»Ñ Ð¾Ð±Ñ…Ð¾Ð´Ð° permission denied
                  timeout 3 sudo docker kill $id 2>/dev/null || timeout 3 docker kill $id 2>/dev/null || true
                  timeout 3 sudo docker stop $id 2>/dev/null || timeout 3 docker stop $id 2>/dev/null || true
                  # ÐŸÑ€Ð¸Ð½ÑƒÐ´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾Ðµ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ðµ
                  timeout 3 sudo docker rm -f $id 2>/dev/null || timeout 3 docker rm -f $id 2>/dev/null || true
                fi
              done
            fi
            
            # Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð°Ñ Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐ°: ÑƒÐ´Ð°Ð»ÑÐµÐ¼ Ð¿Ð¾ Ð¸Ð¼ÐµÐ½Ð°Ð¼ Ñ kill
            echo "ðŸ§¹ Force removing containers by name..."
            for container in nardist_nginx_prod nardist_postgres_prod nardist_redis_prod nardist_backend_prod nardist_frontend_prod nardist_certbot; do
              # Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ kill Ð´Ð»Ñ Ð¿Ñ€Ð¸Ð½ÑƒÐ´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾Ð¹ Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸
              timeout 3 sudo docker kill $container 2>/dev/null || timeout 3 docker kill $container 2>/dev/null || true
              timeout 3 sudo docker stop $container 2>/dev/null || timeout 3 docker stop $container 2>/dev/null || true
              timeout 3 sudo docker rm -f $container 2>/dev/null || timeout 3 docker rm -f $container 2>/dev/null || true
            done
            
            # Ð•ÑÐ»Ð¸ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹ Ð²ÑÐµ ÐµÑ‰Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‚, Ð¿ÐµÑ€ÐµÐ¸Ð¼ÐµÐ½Ð¾Ð²Ñ‹Ð²Ð°ÐµÐ¼ Ð¸Ñ… Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¾ÑÐ²Ð¾Ð±Ð¾Ð´Ð¸Ñ‚ÑŒ Ð¸Ð¼ÐµÐ½Ð°
            REMAINING=$(sudo docker ps -a --filter "name=nardist_" --format "{{.Names}}" 2>/dev/null | wc -l || echo "0")
            if [ "$REMAINING" -gt 0 ]; then
              echo "âš ï¸  Warning: $REMAINING containers still exist, renaming them to free names..."
              # ÐŸÐµÑ€ÐµÐ¸Ð¼ÐµÐ½Ð¾Ð²Ñ‹Ð²Ð°ÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ðµ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹ Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¾ÑÐ²Ð¾Ð±Ð¾Ð´Ð¸Ñ‚ÑŒ Ð¸Ð¼ÐµÐ½Ð° Ð´Ð»Ñ Ð½Ð¾Ð²Ñ‹Ñ…
              sudo docker ps -a --filter "name=nardist_" --format "{{.ID}}|{{.Names}}" 2>/dev/null | while IFS='|' read -r id name; do
                if [ -n "$id" ] && [ -n "$name" ]; then
                  OLD_NAME="$name"
                  NEW_NAME="${name}_old_$(date +%s)"
                  echo "  Renaming: $OLD_NAME -> $NEW_NAME"
                  # ÐŸÑ€Ð¾Ð±ÑƒÐµÐ¼ Ð¿ÐµÑ€ÐµÐ¸Ð¼ÐµÐ½Ð¾Ð²Ð°Ñ‚ÑŒ (Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ Ð´Ð°Ð¶Ðµ ÐµÑÐ»Ð¸ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½)
                  sudo docker rename $OLD_NAME $NEW_NAME 2>/dev/null || \
                  docker rename $OLD_NAME $NEW_NAME 2>/dev/null || true
                fi
              done || true
              sleep 1
              echo "âœ… Old containers renamed, names are now free"
              
              # ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¿ÐµÑ€ÐµÐ¸Ð¼ÐµÐ½Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹ Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¾ÑÐ²Ð¾Ð±Ð¾Ð´Ð¸Ñ‚ÑŒ Ð¿Ð¾Ñ€Ñ‚Ñ‹
              echo "ðŸ›‘ Stopping renamed old containers to free ports..."
              sudo docker ps --filter "name=_old_" --format "{{.Names}}" 2>/dev/null | while read name; do
                if [ -n "$name" ]; then
                  echo "  Stopping old container: $name"
                  # Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ kill Ð´Ð»Ñ Ð¿Ñ€Ð¸Ð½ÑƒÐ´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾Ð¹ Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸
                  timeout 3 sudo docker kill $name 2>/dev/null || timeout 3 docker kill $name 2>/dev/null || true
                fi
              done || true
              sleep 2
            else
              echo "âœ… All containers removed successfully"
            fi
            
            # Ð–Ð´ÐµÐ¼ Ð½ÐµÐ¼Ð½Ð¾Ð³Ð¾ Ñ‡Ñ‚Ð¾Ð±Ñ‹ ÑÐ¸ÑÑ‚ÐµÐ¼Ð° Ð¾ÑÐ²Ð¾Ð±Ð¾Ð´Ð¸Ð»Ð° Ñ€ÐµÑÑƒÑ€ÑÑ‹
            sleep 3
            
            # ÐžÑ‚ÐºÑ€Ñ‹Ð²Ð°ÐµÐ¼ Ð¿Ð¾Ñ€Ñ‚Ñ‹ Ð² firewall (ÐµÑÐ»Ð¸ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ ufw)
            # Ð’ÐÐ–ÐÐž: Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° Ð’Ð¡Ð•Ð“Ð”Ð Ð¾Ñ‚ÐºÑ€Ñ‹Ð²Ð°ÐµÐ¼ SSH (22), Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð½Ðµ Ð·Ð°Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ ÑÐ¾ÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ðµ!
            if command -v ufw &> /dev/null; then
              # Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° Ð´Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð²ÑÐµ Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð° (Ð¾ÑÐ¾Ð±ÐµÐ½Ð½Ð¾ SSH!)
              ufw allow 22/tcp 2>/dev/null || true
              ufw allow 80/tcp 2>/dev/null || true
              ufw allow 443/tcp 2>/dev/null || true
              # Ð’ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÐµÑÐ»Ð¸ ÐµÑ‰Ðµ Ð½Ðµ Ð²ÐºÐ»ÑŽÑ‡ÐµÐ½
              if ! ufw status | grep -q "Status: active"; then
                ufw --force enable 2>/dev/null || true
              fi
            fi
            
            # ÐŸÐµÑ€ÐµÐ¸Ð¼ÐµÐ½Ð¾Ð²Ñ‹Ð²Ð°ÐµÐ¼ Ð¾ÑÑ‚Ð°Ð²ÑˆÐ¸ÐµÑÑ ÑÑ‚Ð°Ñ€Ñ‹Ðµ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹ Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¾ÑÐ²Ð¾Ð±Ð¾Ð´Ð¸Ñ‚ÑŒ Ð¸Ð¼ÐµÐ½Ð°
            echo "ðŸ”„ Renaming remaining old containers to free names..."
            sudo docker ps -a --filter "name=nardist_" --format "{{.ID}}|{{.Names}}" 2>/dev/null | while IFS='|' read -r id name; do
              if [ -n "$id" ] && [ -n "$name" ] && echo "$name" | grep -q "_old_\|_backup_"; then
                # Ð£Ð¶Ðµ Ð¿ÐµÑ€ÐµÐ¸Ð¼ÐµÐ½Ð¾Ð²Ð°Ð½, Ð¿Ñ€Ð¾Ð¿ÑƒÑÐºÐ°ÐµÐ¼
                continue
              elif [ -n "$id" ] && [ -n "$name" ] && ! echo "$name" | grep -qE "^(nardist_nginx_prod|nardist_postgres_prod|nardist_redis_prod|nardist_backend_prod|nardist_frontend_prod|nardist_certbot)$"; then
                # Ð­Ñ‚Ð¾ ÑÑ‚Ð°Ñ€Ñ‹Ð¹ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€ Ñ Ð½ÐµÐ¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ð¼ Ð¸Ð¼ÐµÐ½ÐµÐ¼, Ð¿ÐµÑ€ÐµÐ¸Ð¼ÐµÐ½Ð¾Ð²Ñ‹Ð²Ð°ÐµÐ¼
                NEW_NAME="${name}_backup_$(date +%s)"
                echo "  Renaming: $name -> $NEW_NAME"
                sudo docker rename $name $NEW_NAME 2>/dev/null || true
              fi
            done || true
            sleep 2
            
            # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹ (Ñ‚Ð¾Ð»ÑŒÐºÐ¾ build ÐµÑÐ»Ð¸ Ð¾Ð±Ñ€Ð°Ð·Ñ‹ Ð½Ðµ ÑÐºÐ°Ñ‡Ð°Ð½Ñ‹)
            # Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ sudo ÐµÑÐ»Ð¸ Ð½ÑƒÐ¶Ð½Ð¾, Ð¸Ð½Ð°Ñ‡Ðµ Ð¾Ð±Ñ‹Ñ‡Ð½ÑƒÑŽ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñƒ
            if [ "$BACKEND_PULLED" = true ] && [ "$FRONTEND_PULLED" = true ]; then
              echo "ðŸš€ Using pre-built images, skipping build"
              sudo $DOCKER_COMPOSE -f docker-compose.prod.yml up -d --force-recreate --no-build --pull never --remove-orphans 2>/dev/null || \
              $DOCKER_COMPOSE -f docker-compose.prod.yml up -d --force-recreate --no-build --pull never --remove-orphans
            else
              echo "ðŸ”¨ Building missing images..."
              sudo $DOCKER_COMPOSE -f docker-compose.prod.yml up -d --force-recreate --build --remove-orphans 2>/dev/null || \
              $DOCKER_COMPOSE -f docker-compose.prod.yml up -d --force-recreate --build --remove-orphans
            fi
            
            # Ð–Ð´ÐµÐ¼ Ð³Ð¾Ñ‚Ð¾Ð²Ð½Ð¾ÑÑ‚Ð¸ ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð²
            sleep 10
            
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ Ð²ÑÐµÑ… ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð² Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
            echo "ðŸ” Checking container status after startup..."
            sudo $DOCKER_COMPOSE -f docker-compose.prod.yml ps 2>/dev/null || \
            $DOCKER_COMPOSE -f docker-compose.prod.yml ps || true
            
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÐºÐ°ÐºÐ¸Ðµ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹ ÑÐ¾Ð·Ð´Ð°Ð½Ñ‹ Ð½Ð¾ Ð½Ðµ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½Ñ‹
            echo "ðŸ” Checking stopped containers..."
            sudo docker ps -a --filter "name=nardist_" --format "{{.Names}}|{{.Status}}" 2>/dev/null | grep -v "_old_" | while IFS='|' read -r name status; do
              if [ -n "$name" ] && echo "$status" | grep -q "Exited\|Created\|Dead"; then
                echo "  âš ï¸  Container $name is not running: $status"
                echo "  ðŸ“‹ Logs for $name:"
                sudo docker logs $name --tail 20 2>/dev/null || docker logs $name --tail 20 2>/dev/null || true
              fi
            done || true
            
            # Ð¯Ð²Ð½Ð¾ Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð²ÑÐµ ÑÐµÑ€Ð²Ð¸ÑÑ‹ ÐµÑÐ»Ð¸ Ð¾Ð½Ð¸ Ð½Ðµ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½Ñ‹
            echo "ðŸš€ Ensuring all services are running..."
            for service in nginx backend frontend postgres redis; do
              CONTAINER_NAME="nardist_${service}_prod"
              if ! sudo docker ps 2>/dev/null | grep -q "$CONTAINER_NAME" && ! docker ps 2>/dev/null | grep -q "$CONTAINER_NAME"; then
                echo "  Starting $service..."
                # ÐŸÑ€Ð¾Ð±ÑƒÐµÐ¼ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ Ñ‡ÐµÑ€ÐµÐ· compose
                sudo $DOCKER_COMPOSE -f docker-compose.prod.yml up -d $service 2>/dev/null || \
                $DOCKER_COMPOSE -f docker-compose.prod.yml up -d $service || true
                # Ð•ÑÐ»Ð¸ Ð½Ðµ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ð»ÑÑ, Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð»Ð¾Ð³Ð¸
                sleep 2
                if ! sudo docker ps 2>/dev/null | grep -q "$CONTAINER_NAME" && ! docker ps 2>/dev/null | grep -q "$CONTAINER_NAME"; then
                  echo "  âš ï¸  $service failed to start, checking logs..."
                  sudo docker logs $CONTAINER_NAME --tail 30 2>/dev/null || docker logs $CONTAINER_NAME --tail 30 2>/dev/null || true
                fi
              fi
            done
            sleep 5
            
            # Ð¯Ð²Ð½Ð¾ Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ nginx ÐµÑÐ»Ð¸ Ð¾Ð½ Ð½Ðµ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½
            if ! sudo docker ps 2>/dev/null | grep -q nardist_nginx_prod && ! docker ps 2>/dev/null | grep -q nardist_nginx_prod; then
              echo "âš ï¸  Nginx not running, starting it..."
              sudo $DOCKER_COMPOSE -f docker-compose.prod.yml up -d nginx 2>/dev/null || \
              $DOCKER_COMPOSE -f docker-compose.prod.yml up -d nginx
              sleep 5
            fi
            
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ nginx (Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ sudo ÐµÑÐ»Ð¸ Ð½ÑƒÐ¶Ð½Ð¾)
            if sudo docker ps 2>/dev/null | grep -q nardist_nginx_prod || docker ps 2>/dev/null | grep -q nardist_nginx_prod; then
              echo "âœ… Nginx container is running"
              # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‡Ñ‚Ð¾ nginx Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ ÑÐ»ÑƒÑˆÐ°ÐµÑ‚ Ð½Ð° Ð¿Ð¾Ñ€Ñ‚Ð°Ñ…
              if sudo docker exec nardist_nginx_prod nginx -t 2>/dev/null || docker exec nardist_nginx_prod nginx -t 2>/dev/null; then
                echo "âœ… Nginx configuration is valid"
              else
                echo "âš ï¸  Nginx configuration has errors, checking logs..."
                sudo docker logs nardist_nginx_prod --tail 50 2>/dev/null || docker logs nardist_nginx_prod --tail 50 2>/dev/null || true
              fi
              # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‡Ñ‚Ð¾ Ð¿Ð¾Ñ€Ñ‚Ñ‹ Ð·Ð°Ð½ÑÑ‚Ñ‹ docker ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð¼
              if lsof -i :80 2>/dev/null | grep -q docker || ss -tlnp | grep :80 | grep -q docker; then
                echo "âœ… Port 80 is bound to docker nginx"
              else
                echo "âŒ Port 80 is NOT bound to docker nginx! Checking what's using it..."
                lsof -i :80 2>/dev/null || ss -tlnp | grep :80 || true
              fi
            else
              echo "âŒ Nginx failed to start, checking logs..."
              sudo docker logs nardist_nginx_prod --tail 50 2>/dev/null || docker logs nardist_nginx_prod --tail 50 2>/dev/null || true
              echo "ðŸ”„ Attempting to restart nginx..."
              sudo $DOCKER_COMPOSE -f docker-compose.prod.yml restart nginx 2>/dev/null || \
              $DOCKER_COMPOSE -f docker-compose.prod.yml restart nginx || \
              sudo $DOCKER_COMPOSE -f docker-compose.prod.yml up -d nginx 2>/dev/null || \
              $DOCKER_COMPOSE -f docker-compose.prod.yml up -d nginx
            fi
            
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‡Ñ‚Ð¾ backend ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð¿ÐµÑ€ÐµÐ´ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸ÑÐ¼Ð¸
            echo "ðŸ” Checking backend container status..."
            if ! sudo docker ps 2>/dev/null | grep -q nardist_backend_prod && ! docker ps 2>/dev/null | grep -q nardist_backend_prod; then
              echo "âš ï¸  Backend container not running, starting it..."
              sudo $DOCKER_COMPOSE -f docker-compose.prod.yml up -d backend 2>/dev/null || \
              $DOCKER_COMPOSE -f docker-compose.prod.yml up -d backend
              echo "â³ Waiting for backend to be ready..."
              sleep 10
            fi
            
            # ÐŸÑ€Ð¸Ð¼ÐµÐ½ÑÐµÐ¼ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸ (Ñ Ñ‚Ð°Ð¹Ð¼Ð°ÑƒÑ‚Ð¾Ð¼)
            echo "ðŸ—„ï¸  Running database migrations..."
            # ÐŸÑ€Ð¾Ð±ÑƒÐµÐ¼ Ñ‡ÐµÑ€ÐµÐ· exec (ÐµÑÐ»Ð¸ backend ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½)
            if sudo docker ps 2>/dev/null | grep -q nardist_backend_prod || docker ps 2>/dev/null | grep -q nardist_backend_prod; then
              timeout 60 sudo $DOCKER_COMPOSE -f docker-compose.prod.yml exec -T backend npx prisma migrate deploy 2>/dev/null || \
              timeout 60 $DOCKER_COMPOSE -f docker-compose.prod.yml exec -T backend npx prisma migrate deploy || {
                echo "âš ï¸  Migrations via exec failed, trying with migrations service..."
                timeout 60 sudo $DOCKER_COMPOSE -f docker-compose.prod.yml --profile migrations run --rm migrations 2>/dev/null || \
                timeout 60 $DOCKER_COMPOSE -f docker-compose.prod.yml --profile migrations run --rm migrations || echo "âš ï¸  Migrations failed or not needed"
              }
            else
              # Ð•ÑÐ»Ð¸ backend Ð½Ðµ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½, Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ ÑÐµÑ€Ð²Ð¸Ñ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¹
              echo "âš ï¸  Backend container not running, using migrations service..."
              timeout 60 sudo $DOCKER_COMPOSE -f docker-compose.prod.yml --profile migrations run --rm migrations 2>/dev/null || \
              timeout 60 $DOCKER_COMPOSE -f docker-compose.prod.yml --profile migrations run --rm migrations || echo "âš ï¸  Migrations failed or not needed"
            fi
            
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð²
            echo "ðŸ“Š Container status:"
            sudo $DOCKER_COMPOSE -f docker-compose.prod.yml ps 2>/dev/null || \
            $DOCKER_COMPOSE -f docker-compose.prod.yml ps || true
            
            # ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° (Ð½Ðµ Ð±Ð»Ð¾ÐºÐ¸Ñ€ÑƒÐµÐ¼ ÐµÑÐ»Ð¸ Ð´Ð¾Ð»Ð³Ð¾)
            timeout 30 sudo docker system prune -f 2>/dev/null || timeout 30 docker system prune -f || true
            
            echo "âœ… Deployment completed successfully!"

