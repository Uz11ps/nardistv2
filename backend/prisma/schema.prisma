// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              Int       @id @default(autoincrement())
  telegramId      String    @unique
  firstName       String
  lastName        String?
  username        String?
  languageCode    String    @default("ru")
  isPremium       Boolean   @default(false)
  photoUrl        String?
  nickname        String?
  country         String?
  avatar          String?
  level           Int       @default(1)
  xp              Int       @default(0)
  narCoin         Int       @default(100) // Стартовый набор
  energy          Int       @default(100)
  energyMax       Int       @default(100)
  lives           Int       @default(3)
  livesMax        Int       @default(3)
  power           Int       @default(10) // Сила для ношения скинов
  powerMax        Int       @default(10)
  // Ветки развития
  statsEconomy    Int       @default(0) // Ветка Экономика (снижает комиссию)
  statsEnergy     Int       @default(0) // Ветка Энергия (улучшает реген)
  statsLives      Int       @default(0) // Ветка Жизни (улучшает реген)
  statsPower      Int       @default(0) // Ветка Сила (увеличивает лимит)
  lastEnergyRegen DateTime? // Последняя регенерация энергии/жизней
  referralCode    String    @unique
  referredBy      Int?
  // Онбординг
  onboardingCompleted Boolean @default(false)
  onboardingBotGameCompleted Boolean @default(false)
  onboardingQuickGameCompleted Boolean @default(false)
  onboardingCityViewed Boolean @default(false)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  ratings          Rating[]
  whiteGames       GameHistory[]           @relation("WhiteGames")
  blackGames       GameHistory[]           @relation("BlackGames")
  tournaments      TournamentParticipant[]
  quests           QuestProgress[]
  cityBuildings    CityBuilding[]
  subscription     Subscription?
  academyRole      AcademyRole?
  businesses       Business[]
  resources        Resource[]
  inventoryItems   InventoryItem[]
  clanMembers      ClanMember[]
  marketListings   MarketListing[]
  ownedClans       Clan[]                  @relation("ClanLeader")
  tournamentPasses TournamentPass[]
  jobEmployees     JobEmployee[]           @relation("JobEmployees")

  @@map("users")
}

model Rating {
  id        Int      @id @default(autoincrement())
  userId    Int
  mode      String // SHORT, LONG
  rating    Int      @default(1500) // Elo рейтинг
  wins      Int      @default(0)
  losses    Int      @default(0)
  draws     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, mode])
  @@map("ratings")
}

model GameHistory {
  id            Int      @id @default(autoincrement())
  roomId        String
  mode          String // SHORT, LONG
  whitePlayerId Int
  blackPlayerId Int
  winnerId      Int?
  gameState     Json // Полное состояние игры
  moves         Json // История ходов
  duration      Int? // Длительность в секундах
  // Экономика игры
  betAmount     Int? // Ставка в NAR (если игра на монеты)
  commission    Int? // Комиссия системы
  districtId    Int? // Район, где проходила игра
  createdAt     DateTime @default(now())

  whitePlayer User      @relation("WhiteGames", fields: [whitePlayerId], references: [id])
  blackPlayer User      @relation("BlackGames", fields: [blackPlayerId], references: [id])
  district    District? @relation(fields: [districtId], references: [id])

  @@map("game_history")
}

model Tournament {
  id              Int       @id @default(autoincrement())
  name            String
  description     String?
  mode            String // SHORT, LONG
  format          String // BRACKET, ROUND_ROBIN
  status          String    @default("UPCOMING") // UPCOMING, IN_PROGRESS, FINISHED
  startDate       DateTime
  endDate         DateTime?
  maxParticipants Int?
  hasTournamentPass Boolean  @default(false) // Доступен ли Tournament Pass для этого турнира
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  participants TournamentParticipant[]
  passes       TournamentPass[]

  @@map("tournaments")
}

model TournamentParticipant {
  id           Int      @id @default(autoincrement())
  tournamentId Int
  userId       Int
  position     Int?
  wins         Int      @default(0)
  losses       Int      @default(0)
  createdAt    DateTime @default(now())

  tournament Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([tournamentId, userId])
  @@map("tournament_participants")
}

// Tournament Pass (сезонный пасс для турниров)
model TournamentPass {
  id             Int      @id @default(autoincrement())
  userId         Int
  tournamentId   Int
  isActive       Boolean  @default(true)
  purchasedAt    DateTime @default(now())
  rewardsClaimed Json? // JSON с информацией о полученных наградах

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  tournament Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)

  @@unique([userId, tournamentId])
  @@map("tournament_passes")
}

model Quest {
  id           Int       @id @default(autoincrement())
  type         String // DAILY, WEEKLY, EVENT, INFINITE
  title        String
  description  String
  target       Int // Целевое значение
  rewardCoin   Int       @default(0)
  rewardXp     Int       @default(0)
  rewardSkin   Int?
  isActive     Boolean   @default(true)
  // Новые поля для управления датами и длительностью
  startDate    DateTime? // Дата начала (null = сразу активен)
  endDate      DateTime? // Дата окончания (null = бесконечный)
  durationType String? // EVER, DAY, WEEK, MONTH, CUSTOM
  isHoliday    Boolean   @default(false) // Приурочен к празднику
  isInfinite   Boolean   @default(false) // Бесконечный цикл (повторяется)
  holidayName  String? // Название праздника
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  progress QuestProgress[]

  @@map("quests")
}

model QuestProgress {
  id          Int       @id @default(autoincrement())
  questId     Int
  userId      Int
  progress    Int       @default(0)
  completed   Boolean   @default(false)
  completedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  quest Quest @relation(fields: [questId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([questId, userId])
  @@map("quest_progress")
}

model CityBuilding {
  id            Int       @id @default(autoincrement())
  userId        Int
  buildingType  String // CLUB, WORKSHOP, FACTORY, SCHOOL, etc.
  level         Int       @default(1)
  incomePerHour Int       @default(10)
  lastCollected DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, buildingType])
  @@map("city_buildings")
}

// Фонды районов (для хранения комиссии)
model DistrictFund {
  id          Int      @id @default(autoincrement())
  districtId  Int      @unique
  balance     Int      @default(0) // Баланс в NAR
  lastUpdated DateTime @default(now())
  updatedAt   DateTime @updatedAt

  district District @relation(fields: [districtId], references: [id], onDelete: Cascade)

  @@map("district_funds")
}

model Subscription {
  id        Int      @id @default(autoincrement())
  userId    Int      @unique
  plan      String // MONTHLY, QUARTERLY, YEARLY
  startDate DateTime
  endDate   DateTime
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("subscriptions")
}

model AcademyRole {
  id        Int      @id @default(autoincrement())
  userId    Int      @unique
  role      String   @default("STUDENT") // STUDENT, TRAINER
  level     Int      @default(1)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("academy_roles")
}

model AcademyArticle {
  id          Int      @id @default(autoincrement())
  title       String
  content     String   @db.Text
  authorId    Int?
  isPaid      Boolean  @default(false)
  priceCoin   Int      @default(0)
  priceCrypto String?
  category    String?
  isPublished Boolean  @default(false)
  views       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  purchases ArticlePurchase[]

  @@map("academy_articles")
}

// Покупки статей пользователями
model ArticlePurchase {
  id        Int      @id @default(autoincrement())
  userId    Int
  articleId Int
  paymentMethod String // NAR, TON, USDT, RUBLES, TELEGRAM_STARS
  amount    Int? // Сумма в NAR (если оплата NAR)
  transactionId String? // ID транзакции для криптоплатежей
  createdAt DateTime @default(now())

  user    User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  article AcademyArticle @relation(fields: [articleId], references: [id], onDelete: Cascade)

  @@unique([userId, articleId])
  @@map("article_purchases")
}

model Skin {
  id            Int      @id @default(autoincrement())
  name          String
  type          String // BOARD, DICE, CHECKERS, CUP, FRAME
  previewUrl    String
  rarity        String   @default("COMMON") // COMMON, RARE, EPIC, LEGENDARY, MYTHIC
  weight        Int      @default(1) // Вес предмета
  durabilityMax Int      @default(100) // Максимальная прочность
  isDefault     Boolean  @default(false)
  priceCoin     Int      @default(0)
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())

  inventoryItems InventoryItem[]
  marketListings MarketListing[]

  @@map("skins")
}

// Районы города (7 районов)
model District {
  id             Int      @id @default(autoincrement())
  name           String
  description    String
  type           String // COURTS, CLUBS, WORKSHOPS, FACTORIES, WORKSHOPS_CUPS, SCHOOL, ARENA
  icon           String
  clanId         Int? // Клан, контролирующий район
  commissionRate Int      @default(5) // Комиссия с игр (5%)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  clan        Clan?         @relation(fields: [clanId], references: [id])
  businesses  Business[]
  gameHistory GameHistory[]
  fund        DistrictFund?
  sieges      Siege[] // Осады этого района

  @@map("districts")
}

// Предприятия
model Business {
  id                Int       @id @default(autoincrement())
  userId            Int
  districtId        Int
  type              String // COURT_TABLE, BOARD_WORKSHOP, DICE_FACTORY, CUPS_WORKSHOP, CLUB, SCHOOL, ARENA
  level             Int       @default(1)
  incomePerHour     Int       @default(10) // NAR в час
  productionPerHour Int? // Ресурсов/предметов в час
  storageLimit      Int? // Лимит склада
  storageCurrent    Int       @default(0) // Текущее количество на складе
  maintenanceCost   Int       @default(0) // Стоимость обслуживания в NAR/час
  lastCollected     DateTime?
  lastProduced      DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  district District @relation(fields: [districtId], references: [id], onDelete: Cascade)
  jobPostings JobPosting[] // Вакансии на этом предприятии

  @@unique([userId, districtId, type])
  @@map("businesses")
}

// Вакансии на предприятиях (создаются владельцами)
model JobPosting {
  id            Int      @id @default(autoincrement())
  businessId    Int
  title         String   // Название вакансии
  description   String?  // Описание
  salaryPerHour Int      // Зарплата в NAR за час работы
  energyPerHour Int      @default(10) // Энергия, требуемая за час работы
  maxWorkers    Int      @default(1) // Максимальное количество работников
  currentWorkers Int     @default(0) // Текущее количество работников
  isActive      Boolean  @default(true) // Активна ли вакансия
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  employees JobEmployee[] // Работники на этой вакансии

  @@map("job_postings")
}

// Работники на вакансиях
model JobEmployee {
  id          Int      @id @default(autoincrement())
  jobPostingId Int
  workerId    Int      // ID работника
  hoursWorked Int      @default(0) // Всего отработано часов
  totalEarned Int      @default(0) // Всего заработано NAR
  hiredAt     DateTime @default(now())
  lastWorked  DateTime? // Последний раз работал

  jobPosting JobPosting @relation(fields: [jobPostingId], references: [id], onDelete: Cascade)
  worker     User       @relation("JobEmployees", fields: [workerId], references: [id], onDelete: Cascade)

  @@unique([jobPostingId, workerId])
  @@map("job_employees")
}

// Кланы
model Clan {
  id          Int      @id @default(autoincrement())
  name        String   @unique
  description String?
  leaderId    Int
  treasury    Int      @default(0) // NAR в казне
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  leader          User         @relation("ClanLeader", fields: [leaderId], references: [id])
  members         ClanMember[]
  districts       District[]
  defendingSieges Siege[]      @relation("DefendingSieges")
  attackingSieges Siege[]      @relation("AttackingSieges")

  @@map("clans")
}

// Осады (захват районов)
model Siege {
  id              Int       @id @default(autoincrement())
  districtId      Int
  attackingClanId Int // Клан, который атакует
  defendingClanId Int? // Клан, который защищается (null если район свободен)
  status          String    @default("ACTIVE") // ACTIVE, FINISHED, CANCELLED
  startDate       DateTime  @default(now())
  endDate         DateTime?
  // Результаты осады
  attackingWins   Int       @default(0)
  defendingWins   Int       @default(0)
  requiredWins    Int       @default(5) // Нужно выиграть 5 матчей для победы
  winnerClanId    Int? // Победивший клан
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  district      District    @relation(fields: [districtId], references: [id])
  attackingClan Clan        @relation("AttackingSieges", fields: [attackingClanId], references: [id])
  defendingClan Clan?       @relation("DefendingSieges", fields: [defendingClanId], references: [id])
  siegeGames    SiegeGame[]

  @@map("sieges")
}

// Игры в рамках осады
model SiegeGame {
  id            Int      @id @default(autoincrement())
  siegeId       Int
  whitePlayerId Int
  blackPlayerId Int
  winnerId      Int?
  gameHistoryId Int? // Связь с историей игры
  createdAt     DateTime @default(now())

  siege Siege @relation(fields: [siegeId], references: [id], onDelete: Cascade)

  @@map("siege_games")
}

// Участники клана
model ClanMember {
  id       Int      @id @default(autoincrement())
  clanId   Int
  userId   Int
  role     String   @default("MEMBER") // LEADER, OFFICER, MEMBER
  joinedAt DateTime @default(now())

  clan Clan @relation(fields: [clanId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([clanId, userId])
  @@map("clan_members")
}

// Ресурсы игрока
model Resource {
  id        Int      @id @default(autoincrement())
  userId    Int
  type      String // WOOD, STONE, MARBLE, BONE, PLASTIC, METAL, LEATHER, FABRIC
  amount    Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, type])
  @@map("resources")
}

// Предметы в инвентаре игрока
model InventoryItem {
  id            Int      @id @default(autoincrement())
  userId        Int
  skinId        Int
  rarity        String   @default("COMMON") // COMMON, RARE, EPIC, LEGENDARY, MYTHIC
  durability    Int // Текущая прочность
  durabilityMax Int // Максимальная прочность
  weight        Int // Вес предмета
  isEquipped    Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  skin Skin @relation(fields: [skinId], references: [id], onDelete: Cascade)

  @@map("inventory_items")
}

// Объявления на рынке
model MarketListing {
  id              Int       @id @default(autoincrement())
  userId          Int
  inventoryItemId Int? // Если продается предмет из инвентаря
  skinId          Int? // Если продается новый скин
  price           Int // Цена в NAR
  type            String // FIXED, AUCTION
  auctionEnd      DateTime? // Для аукционов
  currentBid      Int? // Текущая ставка (для аукционов)
  bidderId        Int? // Текущий ставщик
  status          String    @default("ACTIVE") // ACTIVE, SOLD, CANCELLED, EXPIRED
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  user User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  skin Skin? @relation(fields: [skinId], references: [id], onDelete: Cascade)

  @@map("market_listings")
}
