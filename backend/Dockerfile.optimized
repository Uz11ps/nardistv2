# ÐžÐ¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ð¹ Dockerfile Ñ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸ÐµÐ¼ BuildKit cache mounts
# Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ: DOCKER_BUILDKIT=1 docker build -f Dockerfile.optimized -t nardist-backend .

FROM node:18-slim AS builder

WORKDIR /app

# ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ npm Ð´Ð»Ñ Ð¼Ð°ÐºÑÐ¸Ð¼Ð°Ð»ÑŒÐ½Ð¾Ð¹ ÑÐºÐ¾Ñ€Ð¾ÑÑ‚Ð¸
ENV npm_config_loglevel=warn
ENV npm_config_progress=false
ENV npm_config_audit=false
ENV npm_config_fetch_timeout=300000
ENV npm_config_fetch_retries=3
ENV npm_config_fetch_retry_factor=2
ENV npm_config_fetch_retry_mintimeout=5000
ENV npm_config_fetch_retry_maxtimeout=30000
ENV npm_config_cache=/root/.npm
ENV npm_config_prefer_offline=false
ENV npm_config_offline=false

# Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ð±Ð¾Ð»ÐµÐµ Ð±Ñ‹ÑÑ‚Ñ€Ñ‹Ð¹ registry (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾, Ð¼Ð¾Ð¶Ð½Ð¾ Ð·Ð°ÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ)
# RUN npm config set registry https://registry.npmmirror.com/

# ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ package Ñ„Ð°Ð¹Ð»Ñ‹
COPY package*.json ./

# Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ BuildKit cache mount Ð´Ð»Ñ npm ÐºÑÑˆÐ° (Ð·Ð½Ð°Ñ‡Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ ÑƒÑÐºÐ¾Ñ€ÑÐµÑ‚ Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€Ð½Ñ‹Ðµ ÑÐ±Ð¾Ñ€ÐºÐ¸)
RUN --mount=type=cache,target=/root/.npm \
    echo "ðŸ“¦ Installing dependencies..." && \
    npm install --legacy-peer-deps --no-audit --progress=false --prefer-offline=false --fetch-timeout=300000 --maxsockets=15 || \
    (echo "âš ï¸ First attempt failed, retrying..." && \
     sleep 5 && \
     npm install --legacy-peer-deps --no-audit --progress=false --prefer-offline=false --fetch-timeout=300000 --maxsockets=15)

# ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ð¸ÑÑ…Ð¾Ð´Ð½Ñ‹Ð¹ ÐºÐ¾Ð´
COPY . .

# Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ
RUN echo "ðŸ—ï¸ Building application..." && \
    npm run build && \
    echo "âœ… Build completed"

FROM node:18-slim AS production

WORKDIR /app

# ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ npm Ð´Ð»Ñ production
ENV npm_config_loglevel=warn
ENV npm_config_progress=false
ENV npm_config_audit=false

# ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ package.json Ð¸ node_modules Ð¸Ð· builder (Ð±Ñ‹ÑÑ‚Ñ€ÐµÐµ Ñ‡ÐµÐ¼ Ð¿ÐµÑ€ÐµÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ°)
COPY package*.json ./
COPY --from=builder /app/node_modules ./node_modules

# ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ ÑÐ¾Ð±Ñ€Ð°Ð½Ð½Ð¾Ðµ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ
COPY --from=builder /app/dist ./dist

EXPOSE 3000

# Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ healthcheck Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð³Ð¾Ñ‚Ð¾Ð²Ð½Ð¾ÑÑ‚Ð¸ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
    CMD node -e "require('http').get('http://localhost:3000/api/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})" || exit 1

CMD ["node", "dist/main"]
