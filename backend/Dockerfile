FROM node:18-slim AS builder

WORKDIR /app

# –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º npm –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏
ENV npm_config_loglevel=warn
ENV npm_config_progress=false
ENV npm_config_audit=false

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
COPY package*.json ./

# –ò—Å–ø–æ–ª—å–∑—É–µ–º npm ci —Å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–µ–π (–±–µ–∑ --silent –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
RUN echo "üì¶ Installing dependencies..." && \
    npm ci --legacy-peer-deps --no-audit --progress=false || \
    (echo "‚ö†Ô∏è npm ci failed, trying npm install..." && \
     npm install --legacy-peer-deps --no-audit --progress=false)

# –ö–æ–ø–∏—Ä—É–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥
COPY . .

# –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
RUN echo "üèóÔ∏è Building application..." && \
    npm run build && \
    echo "‚úÖ Build completed"

FROM node:18-slim AS production

WORKDIR /app

# –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º npm –¥–ª—è production
ENV npm_config_loglevel=warn
ENV npm_config_progress=false
ENV npm_config_audit=false

# –ö–æ–ø–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ package.json –¥–ª—è production –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
COPY package*.json ./

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ production –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
RUN echo "üì¶ Installing production dependencies..." && \
    npm ci --only=production --legacy-peer-deps --no-audit --progress=false || \
    (echo "‚ö†Ô∏è npm ci failed, trying npm install..." && \
     npm install --only=production --legacy-peer-deps --no-audit --progress=false)

# –ö–æ–ø–∏—Ä—É–µ–º —Å–æ–±—Ä–∞–Ω–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
COPY --from=builder /app/dist ./dist

EXPOSE 3000

CMD ["node", "dist/main"]
