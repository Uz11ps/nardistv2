FROM node:18-slim AS builder

WORKDIR /app

# ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ npm Ð´Ð»Ñ ÑƒÑÐºÐ¾Ñ€ÐµÐ½Ð¸Ñ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸
ENV npm_config_loglevel=warn
ENV npm_config_progress=false
ENV npm_config_audit=false
ENV npm_config_fetch_timeout=300000
ENV npm_config_fetch_retries=5
ENV npm_config_fetch_retry_factor=10
ENV npm_config_fetch_retry_mintimeout=10000
ENV npm_config_fetch_retry_maxtimeout=60000

# Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ð´Ð»Ñ ÐºÑÑˆÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ
COPY package*.json ./

# Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ñ Ñ‚Ð°Ð¹Ð¼Ð°ÑƒÑ‚Ð°Ð¼Ð¸ Ð¸ retry
# Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ cache mount Ð´Ð»Ñ ÑƒÑÐºÐ¾Ñ€ÐµÐ½Ð¸Ñ (Ñ‚Ñ€ÐµÐ±ÑƒÐµÑ‚ BuildKit: DOCKER_BUILDKIT=1)
RUN --mount=type=cache,target=/root/.npm \
    echo "ðŸ“¦ Installing dependencies..." && \
    npm install --legacy-peer-deps --no-audit --progress=false --prefer-offline=false --fetch-timeout=300000 --maxsockets=15 || \
    (echo "âš ï¸ First attempt failed, retrying..." && \
     sleep 5 && \
     npm install --legacy-peer-deps --no-audit --progress=false --prefer-offline=false --fetch-timeout=300000 --maxsockets=15)

# ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ð¸ÑÑ…Ð¾Ð´Ð½Ñ‹Ð¹ ÐºÐ¾Ð´
COPY . .

# Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ
RUN echo "ðŸ—ï¸ Building application..." && \
    npm run build && \
    echo "âœ… Build completed"

FROM node:18-slim AS production

WORKDIR /app

# ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ npm Ð´Ð»Ñ production
ENV npm_config_loglevel=warn
ENV npm_config_progress=false
ENV npm_config_audit=false
ENV npm_config_fetch_timeout=300000
ENV npm_config_fetch_retries=5

# ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ package.json Ð¸ node_modules Ð¸Ð· builder (Ð±Ñ‹ÑÑ‚Ñ€ÐµÐµ Ñ‡ÐµÐ¼ Ð¿ÐµÑ€ÐµÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ°)
COPY package*.json ./
COPY --from=builder /app/node_modules ./node_modules

# ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ ÑÐ¾Ð±Ñ€Ð°Ð½Ð½Ð¾Ðµ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ
COPY --from=builder /app/dist ./dist

EXPOSE 3000

# Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ healthcheck Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð³Ð¾Ñ‚Ð¾Ð²Ð½Ð¾ÑÑ‚Ð¸ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
    CMD node -e "require('http').get('http://localhost:3000/api/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})" || exit 1

CMD ["node", "dist/main"]
