#!/bin/bash

# Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð¸ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ… ÐµÑÐ»Ð¸ ÐµÑ‘ Ð½ÐµÑ‚

set -e

echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…..."
echo ""

cd /opt/Nardist

# Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ
if [ -f .env ]; then
    set -a
    source .env
    set +a
    echo "âœ… Environment variables loaded"
else
    echo "âš ï¸  .env file not found, using defaults"
fi

POSTGRES_USER=${POSTGRES_USER:-nardist}
POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-nardist_password}
POSTGRES_DB=${POSTGRES_DB:-nardist_db}

echo "ðŸ“ ÐŸÐ°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ:"
echo "   User: $POSTGRES_USER"
echo "   Database: $POSTGRES_DB"
echo ""

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‡Ñ‚Ð¾ PostgreSQL Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ (Ñ Ð½ÐµÑÐºÐ¾Ð»ÑŒÐºÐ¸Ð¼Ð¸ Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÐ°Ð¼Ð¸)
echo "â³ ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ PostgreSQL..."
for i in {1..10}; do
    if docker compose -f docker-compose.prod.yml ps postgres | grep -q "Up"; then
        break
    fi
    if [ $i -eq 10 ]; then
        echo "âŒ PostgreSQL ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€ Ð½Ðµ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð¿Ð¾ÑÐ»Ðµ 10 Ð¿Ð¾Ð¿Ñ‹Ñ‚Ð¾Ðº!"
        exit 1
    fi
    sleep 2
done

echo "âœ… PostgreSQL ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½"
echo ""

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚ Ð»Ð¸ Ð±Ð°Ð·Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ…
# ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ÑÑ Ðº ÑÐ¸ÑÑ‚ÐµÐ¼Ð½Ð¾Ð¹ Ð±Ð°Ð·Ðµ Ð´Ð°Ð½Ð½Ñ‹Ñ… 'postgres' Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸
echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑƒÑ‰ÐµÑÑ‚Ð²Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ… '$POSTGRES_DB'..."
DB_EXISTS=$(docker compose -f docker-compose.prod.yml exec -T postgres psql -U "$POSTGRES_USER" -d postgres -tAc "SELECT 1 FROM pg_database WHERE datname='$POSTGRES_DB'" 2>/dev/null || echo "")

if [ "$DB_EXISTS" = "1" ]; then
    echo "âœ… Ð‘Ð°Ð·Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ… '$POSTGRES_DB' ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚"
else
    echo "âš ï¸  Ð‘Ð°Ð·Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ… '$POSTGRES_DB' Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°, ÑÐ¾Ð·Ð´Ð°Ñ‘Ð¼..."
    
    # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð±Ð°Ð·Ñƒ Ð´Ð°Ð½Ð½Ñ‹Ñ…, Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡Ð°ÑÑÑŒ Ðº ÑÐ¸ÑÑ‚ÐµÐ¼Ð½Ð¾Ð¹ Ð±Ð°Ð·Ðµ 'postgres'
    # Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½ÑƒÑŽ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ PGPASSWORD Ð´Ð»Ñ Ð°ÑƒÑ‚ÐµÐ½Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ð¸
    docker compose -f docker-compose.prod.yml exec -T -e PGPASSWORD="$POSTGRES_PASSWORD" postgres psql -U "$POSTGRES_USER" -d postgres -c "CREATE DATABASE $POSTGRES_DB;" 2>&1 || {
        echo "âŒ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ Ð±Ð°Ð·Ñƒ Ð´Ð°Ð½Ð½Ñ‹Ñ…"
        echo "ÐŸÐ¾Ð¿Ñ‹Ñ‚ÐºÐ° Ñ‡ÐµÑ€ÐµÐ· Ð°Ð»ÑŒÑ‚ÐµÑ€Ð½Ð°Ñ‚Ð¸Ð²Ð½Ñ‹Ð¹ Ð¼ÐµÑ‚Ð¾Ð´..."
        # ÐÐ»ÑŒÑ‚ÐµÑ€Ð½Ð°Ñ‚Ð¸Ð²Ð½Ñ‹Ð¹ ÑÐ¿Ð¾ÑÐ¾Ð±: Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñƒ createdb Ñ‡ÐµÑ€ÐµÐ· bash
        docker compose -f docker-compose.prod.yml exec -T -e PGPASSWORD="$POSTGRES_PASSWORD" postgres bash -c "createdb -U $POSTGRES_USER $POSTGRES_DB" 2>&1 || {
            echo "âŒ Ð’ÑÐµ Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÐ¸ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð½Ðµ ÑƒÐ´Ð°Ð»Ð¸ÑÑŒ"
            exit 1
        }
    }
    
    echo "âœ… Ð‘Ð°Ð·Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ… '$POSTGRES_DB' ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ ÑÐ¾Ð·Ð´Ð°Ð½Ð°"
fi

echo ""
echo "ðŸ“Š Ð¡Ð¿Ð¸ÑÐ¾Ðº Ð±Ð°Ð· Ð´Ð°Ð½Ð½Ñ‹Ñ…:"
docker compose -f docker-compose.prod.yml exec -T -e PGPASSWORD="$POSTGRES_PASSWORD" postgres psql -U "$POSTGRES_USER" -d postgres -c "\l" 2>/dev/null || \
docker compose -f docker-compose.prod.yml exec -T postgres psql -U "$POSTGRES_USER" -d postgres -c "\l"

echo ""
echo "âœ… ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°!"
